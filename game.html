<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Open Game Vault - Game Details</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <header>
    <div class="title-row">
      <a href="index.html" class="btn back-link" aria-label="Back to home"><span class="icon" aria-hidden="true">‚Üê</span> <span class="label">Home</span></a>
      <h1 id="game-title">Game</h1>
    </div>
  </header>
  <main>
    <section class="game game-details" id="game-details">
      <div class="about-header"><h2>About</h2><span id="about-release-date" class="release-date" hidden></span></div>
      <p id="game-description"></p>
      <h2>Gallery</h2>
      <div class="gallery" id="game-gallery"></div>
  <h2 id="downloads-title">Download</h2>
  <div class="game-buttons" id="game-downloads"></div>
    </section>
  </main>
  <footer>
  <p>&copy; 2025 Open Game Vault. All rights reserved.</p>
  </footer>
  <script>
    document.documentElement.setAttribute('data-page', 'game');
  </script>
  <script src="js/script.js"></script>
  <script src="js/gallery.js"></script>
  <script>
    // Toggle to temporarily hide downloads across all game pages
    const SHOW_DOWNLOADS = false;
    // Ensure logo never overlaps side buttons (back, music) regardless of extreme aspect ratios
    function adjustLogoSafety() {
      try {
        const titleRow = document.querySelector('header .title-row');
        const back = document.querySelector('header .title-row .back-link');
        const logo = document.querySelector('#game-title .game-logo');
        if (!titleRow || !back || !logo) return;
        const music = document.querySelector('header .music-toggle');
        const rowRect = titleRow.getBoundingClientRect();
        const backRect = back.getBoundingClientRect();
        const musicRect = music ? music.getBoundingClientRect() : null;
        // Prepare baseline padding (store once)
        const titleEl = document.getElementById('game-title');
        if (!titleEl) return;
        if (!titleEl.dataset.basePadLeft) {
          const cs = getComputedStyle(titleEl);
            titleEl.dataset.basePadLeft = cs.paddingLeft.replace('px','');
            titleEl.dataset.basePadRight = cs.paddingRight.replace('px','');
        }
        // Reset any previous dynamic adjustments so calculations are fresh
        titleEl.style.paddingLeft = titleEl.dataset.basePadLeft + 'px';
        // Space reserved on left/right: gutter to button + button width + gap
        const leftReserve = (backRect.left - rowRect.left) + backRect.width + 8;
        const rightReserve = musicRect ? (rowRect.right - musicRect.right) + musicRect.width + 8 : 8;
        const available = Math.max(80, rowRect.width - leftReserve - rightReserve);
        logo.style.maxWidth = available + 'px';
        // After width constraint, ensure logo doesn't visually collide with back button
        const logoRect = logo.getBoundingClientRect();
        if (logoRect.left < backRect.right + 4) {
          const shift = (backRect.right + 4) - logoRect.left;
          const base = parseFloat(titleEl.dataset.basePadLeft)||0;
          titleEl.style.paddingLeft = (base + shift) + 'px';
        }
      } catch {}
    }
    let _logoResizeTimer; 
    window.addEventListener('resize', () => { clearTimeout(_logoResizeTimer); _logoResizeTimer = setTimeout(adjustLogoSafety, 120); });
    window.addEventListener('orientationchange', () => { setTimeout(adjustLogoSafety, 60); });
  (async function(){
    const params = new URLSearchParams(window.location.search);
    const slug = params.get('g');
    if (!slug) return;
  // Set gallery identifiers synchronously so gallery.js can derive immediately
  const galleryEl = document.getElementById('game-gallery');
  if (galleryEl) galleryEl.dataset.game = slug;
  const section = document.getElementById('game-details');
  if (section) section.dataset.folder = `assets/games/galleries/${slug}`;
    try {
      const res = await fetch('assets/data/games.json', { cache: 'no-cache' });
      const data = await res.json();
      const game = data[slug];
      if (!game) return;
      // Title
      const titleEl = document.getElementById('game-title');
      const titleText = game.name || slug;
      titleEl.textContent = titleText;
      // Try logo swap: prefer assets/games/logos/<slug>/logo.*
      try {
        const candidates = [
          `assets/games/logos/${slug}/logo.webp`,
          `assets/games/logos/${slug}/logo.png`,
          `assets/games/logos/${slug}/logo.jpg`,
          `assets/games/logos/${slug}/logo.jpeg`
        ];
        let i = 0;
        const tryNext = () => {
          if (i >= candidates.length) return;
          const test = new Image();
          test.onload = () => {
            const img = document.createElement('img');
            img.src = candidates[i];
            img.alt = `${titleText} logo`;
            img.className = 'game-logo';
            // Keep text title for accessibility but visually hide it
            titleEl.textContent = '';
            titleEl.appendChild(img);
            const sr = document.createElement('span');
            sr.textContent = titleText;
            sr.className = 'sr-only';
            titleEl.appendChild(sr);
            // No JS centering needed now; CSS ensures centering
            requestAnimationFrame(adjustLogoSafety);
          };
          test.onerror = () => { i++; tryNext(); };
          test.src = candidates[i];
        };
        tryNext();
      } catch {}
      document.title = `${game.name || slug} - Game Details`;
      // Description
      document.getElementById('game-description').textContent = game.description || '';
      // Release date inline in About heading
      try {
        const span = document.getElementById('about-release-date');
        if (span && game.releaseDate) {
          const dt = new Date(game.releaseDate);
          if (!isNaN(dt.getTime())) {
            span.textContent = dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
            span.removeAttribute('hidden');
          }
        }
      } catch {}
      // Tags (if any)
      if (Array.isArray(game.tags) && game.tags.length) {
        const details = document.getElementById('game-details');
        if (details && !details.querySelector('.tags')) {
          const TAG_ORDER = [
            'singleplayer','story','campaign','coop','co-op','multiplayer','online','pvp','pve','survival','sandbox','open-world','strategy','fps','rpg','action','adventure','horror','roguelike','indie','early-access','beta'
          ];
          const orderMap = new Map(); TAG_ORDER.forEach((t,i)=>orderMap.set(t,i));
          const sortedTags = game.tags.slice().sort((a,b)=>{
            const al = a.toLowerCase(); const bl = b.toLowerCase();
            const ai = orderMap.has(al)?orderMap.get(al):Number.MAX_SAFE_INTEGER;
            const bi = orderMap.has(bl)?orderMap.get(bl):Number.MAX_SAFE_INTEGER;
            if (ai !== bi) return ai - bi;
            return al.localeCompare(bl);
          });
          const tagWrap = document.createElement('div');
          tagWrap.className = 'tags';
          tagWrap.setAttribute('aria-label','Tags');
          tagWrap.innerHTML = sortedTags.map(t => `<span class="tag">${t}</span>`).join('');
          // Insert a dedicated Tags heading right after the About description
          const desc = document.getElementById('game-description');
          let tagsHeading = details.querySelector('h2.tags-heading');
          if (!tagsHeading) {
            tagsHeading = document.createElement('h2');
            tagsHeading.textContent = 'Tags';
            tagsHeading.className = 'tags-heading';
            if (desc) desc.insertAdjacentElement('afterend', tagsHeading); else details.insertBefore(tagsHeading, details.querySelector('h2:nth-of-type(2)'));
          }
          tagsHeading.insertAdjacentElement('afterend', tagWrap);
          // Add data-tags for consistency (not used on details page search currently)
          details.dataset.tags = game.tags.join(',');
        }
      }
      // Links section (appears only if links exist). Insert after Gallery section.
      if (game.links && typeof game.links === 'object') {
        const links = Object.entries(game.links).filter(([k,v]) => typeof v === 'string' && v.trim());
        if (links.length) {
          const details = document.getElementById('game-details');
          const galleryEl = document.getElementById('game-gallery');
          if (details && galleryEl && !details.querySelector('.external-links')) {
            const linksHeading = document.createElement('h2');
            linksHeading.textContent = 'Links';
            const container = document.createElement('div');
            container.className = 'external-links';
            links.forEach(([key,url]) => {
              const btn = document.createElement('a');
              btn.className = 'btn external-link';
              btn.href = url;
              btn.target = '_blank';
              btn.rel = 'noopener noreferrer';
              // Format key (steam -> Steam)
              const label = key.replace(/[-_]+/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
              btn.textContent = label;
              container.appendChild(btn);
            });
            // Insert after gallery element
            galleryEl.insertAdjacentElement('afterend', container);
            galleryEl.insertAdjacentElement('afterend', linksHeading);
          }
        }
      }
  // No features anymore; description-only
  // Gallery setup: keep derived folder unless JSON overrides it
  if (game.galleryFolder && section) section.dataset.folder = game.galleryFolder;
      // Downloads
      if (!SHOW_DOWNLOADS) {
        const t = document.getElementById('downloads-title');
        const dlEl = document.getElementById('game-downloads');
        if (t) t.style.display = 'none';
        if (dlEl) dlEl.style.display = 'none';
        return; // skip rendering downloads
      }
      const dlEl = document.getElementById('game-downloads');
      dlEl.innerHTML = '';
      const dls = game.downloads || {};
      // Derive default Windows download if not provided: assets/downloads/<slug>/<slug>-windows.7z
      const winUrl = dls.windows || `assets/downloads/${slug}/${slug}-windows.7z`;
      // If an explicit URL is provided, render it directly
      if (dls.windows) {
        const a = document.createElement('a');
        a.href = winUrl;
        a.textContent = 'Download for Windows';
        dlEl.appendChild(a);
      } else {
        // Probe the derived URL; enable link only if it exists
        try {
          const head = await fetch(winUrl, { method: 'HEAD', cache: 'no-cache' });
          if (head.ok) {
            const a = document.createElement('a');
            a.href = winUrl;
            a.textContent = 'Download for Windows';
            dlEl.appendChild(a);
          } else {
            const a = document.createElement('a');
            a.href = '#';
            a.setAttribute('aria-disabled', 'true');
            a.onclick = () => false;
            a.className = 'btn';
            a.textContent = 'Download for Windows';
            dlEl.appendChild(a);
          }
        } catch (_) {
          const a = document.createElement('a');
          a.href = '#';
          a.setAttribute('aria-disabled', 'true');
          a.onclick = () => false;
          a.className = 'btn';
          a.textContent = 'Download for Windows';
          dlEl.appendChild(a);
        }
      }
    } catch (e) {
      // fail silently
    }
  })();
  </script>
</body>
</html>
